{% extends "staff_panel/panel.html" %}
{% load static %}
{% load vote_filters %}
{% load dict_filters %}

{% block page_title %}{{ meeting.title }}{% endblock %}

{% block action_buttons %}
  <a href="{% url 'meeting_delete' view.object.pk %}" class="btn btn-outline-danger">ğŸ—‘ Delete</a>
  <a href="{% url 'staff_meeting_list'  %}" class="header-btn">â† Back to Meeting</a>
{% endblock %}

{% block main_content %}
<div class="row">
  <div class="col-md-6">
    <!-- ğŸ—“ Meeting Info -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span>ğŸ—“ Meeting Info</span>
        <a href="{% url 'meeting_edit' meeting.pk %}" class="btn btn-sm btn-light">âœï¸ Edit</a>
      </div>
      <div class="card-body">
        <p><strong>Date:</strong> {{ meeting.date|date:"Y/m/d H:i" }}</p>
        <p><strong>Type:</strong> {{ meeting.get_meeting_type_display }}</p>
        <p><strong>Status:</strong> {{ meeting.get_status_display }}</p>
        <p><strong>Location:</strong> {{ meeting.location|default:"â€”" }}</p>
        {% if meeting.online_link %}
          <p><strong>Online Link:</strong> <a href="{{ meeting.online_link }}" target="_blank">{{ meeting.online_link }}</a></p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <!-- ğŸ“‹ Agenda Items -->
	<div class="card mb-4">
	<div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
		<span>ğŸ“‹ Agenda Items</span>
		<a href="{% url 'agenda_create' meeting.pk %}" class="btn btn-sm btn-light">â• New</a>
	</div>
	<div class="table-responsive">
		{% if agenda_items %}
		<table class="table table-bordered table-hover">
			<thead class="table-light">
			<tr>
				<th>#</th>
				<th>Title</th>
				<th>Order</th>
				<th>Description</th>
				<th>File</th>
				<th>Vote?</th>
				<th>Actions</th>
			</tr>
			</thead>
			<tbody>
			{% for item in agenda_items %}
			<tr>
				<td>{{ forloop.counter }}</td>
				<td>{{ item.title }}</td>
				<td>{{ item.order }}</td>
				<td>{{ item.description|default:"No description." }}</td>
				<td>
				{% if item.file %}
					<a href="{{ item.file.url }}" target="_blank">ğŸ“ File</a>
				{% else %}
					â€”
				{% endif %}
				</td>
				<td>{% if item.requires_vote %}âœ”ï¸{% else %}â€”{% endif %}</td>
				<td>
				<a href="{% url 'agenda_edit' item.pk %}" class="btn btn-sm btn-outline-primary">âœï¸</a>
				<a href="{% url 'agenda_delete' item.pk %}" class="btn btn-sm btn-outline-danger">ğŸ—‘ï¸</a>
				</td>
			</tr>
			{% endfor %}
			</tbody>
		</table>
		{% else %}
		<p>No agenda items recorded.</p>
		{% endif %}
	</div>
	</div>	
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <!-- ğŸ‘¥ Invitees -->
	<div class="card mb-4">
		<div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
			<span>ğŸ‘¥ Invitees</span>
			<a href="{% url 'invite_create' meeting.pk %}" class="btn btn-sm btn-light">â• New</a>
		</div>
		<div class="card-body">
			{% if invitees %}
			<div class="table-responsive">
				<table class="table table-bordered table-hover">
				<thead class="table-light">
					<tr>
					<th>#</th>	
					<th>Name</th>
					<th>Status</th>
					<th>Responded At</th>
					<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for invite in invitees %}
					<tr>
					<td>{{ forloop.counter }}</td>
					<td>{{ invite.invited_user.get_full_name }}</td>
					<td><strong>{{ invite.get_status_display }}</strong></td>
					<td>
						{% if invite.responded_at %}
						{{ invite.responded_at|date:"Y/m/d H:i" }}
						{% else %}
						â€”
						{% endif %}
					</td>
					<td>
						<a href="{% url 'invite_edit' invite.pk %}" class="btn btn-sm btn-outline-primary">âœï¸</a>
						<a href="{% url 'invite_delete' invite.pk %}" class="btn btn-sm btn-outline-danger">ğŸ—‘ï¸</a>
					</td>
					</tr>
					{% endfor %}
				</tbody>
				</table>
			</div>
			{% else %}
			<p>No invitees listed.</p>
			{% endif %}
		</div>
  	</div>
  </div>
  <div class="col-md-6">
	<!-- ğŸ“„ Minutes -->
	<div class="card mb-4">
		<div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
			<span>ğŸ“„ Minutes</span>
			{% if minutes %}
			<div>
				<a href="{% url 'minutes_edit' minutes.pk %}" class="btn btn-sm btn-light">âœï¸ Edit</a>
				<a href="{% url 'minutes_delete' minutes.pk %}" class="btn btn-sm btn-danger ms-2">ğŸ—‘ï¸ Delete</a>
			</div>
			{% else %}
			<a href="{% url 'minutes_create' meeting.pk %}" class="btn btn-sm btn-light">â• Create</a>
			{% endif %}
		</div>
		<div class="card-body">
			{% if minutes %}
			<p><strong>Status:</strong> {{ minutes.get_status_display }}</p>
			<p><strong>Summary:</strong> {{ minutes.summary }}</p>
			{% if minutes.body %}
				<p>{{ minutes.body|linebreaks }}</p>
			{% endif %}
			{% if minutes.file %}
				<p><a href="{{ minutes.file.url }}" target="_blank">ğŸ“ Download Minutes File</a></p>
			{% endif %}
			<p><small>Recorded by: {{ minutes.recorded_by.get_full_name|default:"â€”" }}</small></p>
			{% if minutes.approved_by %}
				<p><small>Approved by: {{ minutes.approved_by.get_full_name }} at {{ minutes.approved_at|date:"Y/m/d H:i" }}</small></p>
			{% endif %}
			{% else %}
			<p>No minutes recorded.</p>
			{% endif %}
		</div>
	</div>
  </div>
</div>
  
<!-- ğŸ“Œ Motions & Votes -->
<div class="row">
  <div class="col-12">
    <div class="card mb-4">
      <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
		<span>ğŸ“Œ Motions & Votes</span>
        <a href="#" class="btn btn-sm btn-outline-dark">â• New</a>
      </div>
      <div class="card-body">
        {% if motions %}
          <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Text</th>
                  <th>Agenda</th>
                  <th>Proposed By</th>
                  <th>Yes</th>
                  <th>No</th>
                  <th>Abstain</th>
                  <th>Total Votes</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                {% for motion in motions %}
                  {% with votes=votes_by_motion|dict_get:motion.id %}
                    <tr>
                      <td>{{ motion.id }}</td>
                      <td>{{ motion.text|truncatewords:10 }}</td>
                      <td>{{ motion.agenda_item.title }}</td>
                      <td>{{ motion.created_by.get_full_name|default:"â€”" }}</td>
                      <td>{{ votes|yes_count }}</td>
                      <td>{{ votes|no_count }}</td>
                      <td>{{ votes|abstain_count }}</td>
                      <td>{{ votes|length }}</td>
                      <td>
                        <a href="{% url 'motion-detail' motion.id %}" class="btn btn-sm btn-outline-primary">ğŸ” View</a>
                      </td>
                    </tr>
                  {% endwith %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>No motions proposed.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
