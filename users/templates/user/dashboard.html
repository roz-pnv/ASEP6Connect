{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="dashboard">
  <!-- Toggle Button -->
  <button id="toggleSidebar" class="sidebar-toggle-btn">â˜°</button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <ul>
      <a href="{% url 'dashboard' %}" class="site-title-link">
        <h4 class="mb-4">User Panel</h4>
      </a>
      <li>
        <span class="main-link" data-parent="my-info">My Info</span>
        <ul class="submenu" id="my-info-submenu" style="display:none;">
          <li class="tab-link" data-tab="personal-info">Personal Info</li>
          {% if student_profile %}
            <li class="tab-link" data-tab="student-info">Student Info</li>
          {% endif %}
          <li class="tab-link" data-tab="membership-info">Membership Info</li>
        </ul>
      </li>

      <li>
        <a href="{% url 'my_invitations' %}" class="tab-link" data-tab="invitations-tab">My Invitations</a>
      </li>
      <li>
        <a href="{% url 'wallet-overview' %}" class="tab-link" data-tab="invitations-tab">My Wallet</a>
      </li>

      {% if board_role %}
        <li><a href="{% url 'staff_panel' %}">Board Panel</a></li>
      {% endif %}
    </ul>
  </aside>

  <!-- Main Content Area -->
  <section class="tab-content">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    {% block main_content %}
        <!-- Personal Info Tab -->
        <div id="personal-info" class="tab-pane active">
          <h2>Welcome, {{ user.username }}</h2>
          <h4>Personal Information</h4>
          <ul>
            <li>Email: {{ user.email }}</li>
            <li>Full Name: {{ user.first_name }} {{ user.last_name }}</li>
            <li>Gender: {{ user.get_gender_display }}</li>
            <li>Country of Origin: {{ user.country_of_origin }}</li>
            <li>Job: {{ user.job }}</li>
            <li>Address: {{ user.address }}</li>
            <li>Language: {{ user.language }}</li>
            <li>Birthdate: {{ user.birthdate }}</li>
          </ul>
          <a href="{% url 'profile_update' %}" class="btn btn-primary mt-3">Update Profile</a>
        </div>

        {% if student_profile %}
        <div id="student-info" class="tab-pane">
          <h4>Student Information</h4>
          <ul>
            <li>Field of Study: {{ student_profile.field_of_study }}</li>
            <li>Arrival Date: {{ student_profile.arrival_date }}</li>
            <li>Accommodation: {{ student_profile.accommodation_type }}</li>
          </ul>
          <a href="{% url 'student_profile_update' %}" class="btn btn-primary mt-3">Edit Student Info</a>
        </div>
        {% endif %}

        <div id="membership-info" class="tab-pane">
          <h4>Membership</h4>
          {% if membership %}
            <ul>
              <li>Type: {{ membership.get_member_type_display }}</li>
              <li>Status: 
                {% if membership.is_confirmed %}
                  {% if membership.is_expired %} Expired {% else %} Active {% endif %}
                {% else %}
                  Pending
                {% endif %}
              </li>
              <li>Expiry Date: {{ membership.membership_expiry|default:"Not set" }}</li>
            </ul>
          {% else %}
            <p>You do not have a membership.</p>
          {% endif %}

          <div class="action-buttons mt-3">
            {% if not membership or membership.is_expired %}
              <a href="{% url 'membership_request' %}" class="btn btn-success">Request Membership</a>
            {% elif not membership.is_confirmed %}
              <button class="btn btn-secondary" disabled>Membership Request Sent</button>
            {% else %}
              <button class="btn btn-secondary" disabled>Active Membership</button>
            {% endif %}
          </div>

          {% if membership_history %}
            <hr>
            <h5 class="mt-4">Membership History</h5>
            <table class="table table-bordered table-sm">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Requested On</th>
                  <th>Expiry Date</th>
                  <th>Can Vote</th>
                </tr>
              </thead>
              <tbody>
                {% for m in membership_history %}
                  <tr>
                    <td>{{ m.get_member_type_display }}</td>
                    <td>
                      {% if m.is_confirmed %}
                        {% if m.is_expired %}Expired{% else %}Active{% endif %}
                      {% else %}
                        Pending
                      {% endif %}
                    </td>
                    <td>{{ m.created_at|date:"Y-m-d" }}</td>
                    <td>{{ m.membership_expiry|default:"Not set"|date:"Y-m-d" }}</td>
                    <td>{{ m.can_vote }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>
        
    {% endblock %}
  </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}
